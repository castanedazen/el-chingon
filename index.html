<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cruzando los Nopales ‚Äî Edici√≥n Fiesta</title>
<style>
  :root{
    --rojo:#e11d48; --verde:#16a34a; --blanco:#ffffff; --negro:#111827;
    --azul:#1f3fb7; --amarillo:#f59e0b;
  }
  html,body{height:100%;margin:0;background:#fff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--negro)}
  .wrap{max-width:1100px;margin:0 auto;padding:12px}
  header{display:flex;flex-wrap:wrap;align-items:center;gap:10px;justify-content:space-between}
  h1{margin:0;font-size:clamp(20px,3.5vw,34px);color:var(--rojo);text-shadow:0 2px 0 #fff}
  .btn{cursor:pointer;border:2px solid var(--negro);border-radius:12px;padding:.45rem .8rem;font-weight:800;background:#fff;box-shadow:2px 3px 0 var(--negro)}
  .grid{display:grid;grid-template-columns:1fr 320px;gap:12px}
  canvas{width:100%;aspect-ratio:4/3;border:4px solid var(--negro);border-radius:16px;box-shadow:6px 8px 0 var(--negro);background:#fff}
  .col{display:flex;flex-direction:column;gap:10px}
  .kbd{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .kbd .btn{font-size:18px;padding:14px 10px}
  .status{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .tag{border:2px solid var(--negro);background:#fff;padding:.25rem .5rem;border-radius:10px;font-weight:700}
  .hist{background:#fff;border:2px solid var(--negro);border-radius:14px;padding:10px;max-height:340px;overflow:auto}
  table{border-collapse:collapse;width:100%} th,td{border:1px solid #ddd;padding:6px 8px;font-size:12px;text-align:center}
  th{background:#f3f4f6;position:sticky;top:0}
  .toast{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .toast span{font-weight:900;font-size:clamp(22px,4.5vw,40px);background:rgba(255,255,255,.9);border:4px solid var(--negro);
              padding:.6rem 1rem;border-radius:16px;box-shadow:6px 8px 0 var(--negro)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üá≤üáΩ Cruzando los Nopales ‚Äî ¬°Fiest√≥n!</h1>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btnStart">Iniciar</button>
      <button class="btn" id="btnPause">Pausar</button>
      <button class="btn" id="btnReset">Reiniciar</button>
    </div>
  </header>

  <div class="grid">
    <div style="position:relative">
      <canvas id="game" width="800" height="600" aria-label="Juego Cruzando los Nopales"></canvas>
      <div class="toast" id="toast" style="display:none"><span></span></div>
      <div class="status">
        <span class="tag">Vidas: <b id="lives">3</b></span>
        <span class="tag">Puntos: <b id="score">0</b></span>
        <span class="tag">Nivel: <b id="level">1</b></span>
        <span class="tag">Golpes: <b id="hits">0</b></span>
        <span class="tag">Tiempo: <b id="time">0.0s</b></span>
      </div>
    </div>

    <div class="col">
      <div class="kbd" aria-label="Controles t√°ctiles">
        <div></div>
        <button class="btn" data-dir="up">‚¨Ü Arriba</button>
        <div></div>
        <button class="btn" data-dir="left">‚¨Ö Izquierda</button>
        <button class="btn" data-dir="down">‚¨á Abajo</button>
        <button class="btn" data-dir="right">‚û° Derecha</button>
      </div>

      <div class="hist">
        <b>Historial</b>
        <div style="display:flex;gap:6px;margin:.4rem 0">
          <button class="btn" id="btnExport">Exportar CSV</button>
          <button class="btn" id="btnPrint">Imprimir reporte</button>
          <button class="btn" id="btnClear">Borrar historial</button>
        </div>
        <table id="table">
          <thead><tr><th>Fecha</th><th>Nivel</th><th>Puntos</th><th>Vidas</th><th>Golpes</th><th>Tiempo</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <details>
        <summary><b>C√≥mo publicar en GitHub Pages</b></summary>
        <ol>
          <li>Guarda este archivo como <code>index.html</code>.</li>
          <li>Opcional: coloca tu imagen como <code>player.png</code> junto a <code>index.html</code>.</li>
          <li>Sube al repositorio ‚Üí Settings ‚Üí Pages ‚Üí Source: ‚Äúmain / root‚Äù.</li>
          <li>Abre la URL de Pages. ¬°Listo!</li>
        </ol>
      </details>
    </div>
  </div>
</div>

<script>
/* ==================== util ==================== */
const $ = s=>document.querySelector(s);
const rand=(a,b)=>Math.random()*(b-a)+a;
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

/* ==================== canvas & estado ==================== */
const canvas=$("#game"), ctx=canvas.getContext("2d");
const W=canvas.width, H=canvas.height;

const state={
  running:false, paused:false,
  level:1, score:0, lives:3, hits:0,
  timeStart:0,
  slowUntil:0, bootsUntil:0,
  obstacles:[], nopales:[], drops:[]
};

const player={ x:W/2, y:H-60, size:26, speed:6, img:null, ready:false,
  reset(){ this.x=W/2; this.y=H-60; }
};

/* Carga opcional de imagen 'player.png' */
(function loadSprite(){
  const img=new Image();
  img.onload=()=>{ player.img=img; player.ready=true; };
  img.onerror=()=>{ player.img=null; player.ready=true; };
  img.src="player.png"; // pon tu caricatura aqu√≠ (mismo folder)
})();

/* ==================== audio (sfx + mariachi loop) ==================== */
let ac, bgGain, loopId;
function audioInit(){
  if(ac) return;
  ac = new (window.AudioContext||window.webkitAudioContext)();
  bgGain = ac.createGain(); bgGain.gain.value=0.08; bgGain.connect(ac.destination);
}
function beep(type=0){
  if(!ac) return;
  const o=ac.createOscillator(), g=ac.createGain();
  o.connect(g); g.connect(ac.destination);
  o.type=["square","triangle","sine"][type%3];
  o.frequency.value = type===0? 880 : type===1? 523 : 659;
  g.gain.setValueAtTime(0.001, ac.currentTime);
  g.gain.exponentialRampToValueAtTime(0.3, ac.currentTime+0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.25);
  o.start(); o.stop(ac.currentTime+0.26);
}
function startMariachi(){
  if(!ac || loopId) return;
  const tempo=120, beat=60/tempo;
  const prog=[261.63,329.63,392.00,523.25]; // C‚ÄìE‚ÄìG‚ÄìC
  let step=0;
  loopId=setInterval(()=>{
    for(let v=0;v<2;v++){
      const o=ac.createOscillator(), g=ac.createGain();
      o.type=v? "triangle":"sawtooth";
      o.frequency.value=prog[step%prog.length]*(v?1:0.5);
      g.gain.value=0.05; o.connect(g); g.connect(bgGain);
      o.start(); o.stop(ac.currentTime+beat*0.9);
    }
    step++;
  }, beat*1000);
}
function stopMariachi(){ if(loopId){ clearInterval(loopId); loopId=null; }}

/* ==================== mundo ==================== */
function makeLevel(n){
  state.obstacles.length=0; state.nopales.length=0; state.drops.length=0;

  // carriles (guardias gen√©ricos)
  const lanes=4+Math.min(4,n);
  for(let i=0;i<lanes;i++){
    const y = 120 + i*60;
    const speed = (1.2 + n*0.25) * (i%2?1:-1);
    const count = 3 + Math.floor(n/2);
    for(let k=0;k<count;k++){
      state.obstacles.push({
        x:rand(0,W), y, w:90, h:38,
        v:speed*rand(1.0,1.6),
        jacket: i%2? "#b9d0ff" : "#9db7ff"
      });
    }
  }

  // nopales
  const patches=4+Math.min(8,n*2);
  for(let i=0;i<patches;i++){
    state.nopales.push({ x:rand(30,W-80), y:rand(220,H-160), r:rand(22,36) });
  }

  // power-ups
  state.drops.push({type:"agua", x:rand(30,W-30), y:rand(140,H-200), r:14, color:"#1f7aff"});
  state.drops.push({type:"botas", x:rand(30,W-30), y:rand(140,H-200), r:14, color:"#f59e0b"});
}

/* ==================== dibujo ==================== */
function drawTricolor(){
  const stripe=H/3;
  ctx.fillStyle="#128a3a"; ctx.fillRect(0,0,W,stripe);         // verde
  ctx.fillStyle="#ffffff"; ctx.fillRect(0,stripe,W,stripe);    // blanco
  ctx.fillStyle="#d01c1f"; ctx.fillRect(0,2*stripe,W,stripe);  // rojo
  // zona de meta
  ctx.save(); ctx.globalAlpha=.18; ctx.fillStyle="#000"; ctx.fillRect(0,0,W,60); ctx.restore();
  ctx.strokeStyle="#111"; ctx.strokeRect(0,0,W,60);
  ctx.fillStyle="#111"; ctx.font="bold 16px system-ui"; ctx.fillText("META", W/2-20, 36);
}

function drawPlayer(){
  const {x,y,size} = player;

  // sombra
  ctx.fillStyle="rgba(0,0,0,.15)";
  ctx.beginPath(); ctx.ellipse(x, y+size*0.9, size*0.8, size*0.35, 0, 0, Math.PI*2); ctx.fill();

  if(player.img){
    const h=size*2.4, w=h*0.9;
    ctx.drawImage(player.img, x-w/2, y-h/1.7, w, h);
    return;
  }

  // fallback: jersey rayado (sin logos)
  ctx.lineWidth=2; ctx.strokeStyle="#111";
  const torsoW=size*1.2, torsoH=size*1.1;
  const left = x - torsoW/2, top = y - torsoH/2;
  for(let i=0;i<6;i++){
    ctx.fillStyle = i%2===0? "#ffffff" : "#e11d48";
    ctx.fillRect(left + i*(torsoW/6), top, torsoW/6, torsoH);
  }
  ctx.strokeRect(left, top, torsoW, torsoH);
  ctx.fillStyle="#f1c27d"; ctx.fillRect(x-10, top-10, 20, 10); // cuello
  ctx.beginPath(); ctx.arc(x, top-20, 16, 0, Math.PI*2); ctx.fill(); ctx.stroke(); // cabeza
  ctx.fillRect(left-6, top+10, 12, 22); ctx.fillRect(left+torsoW-6, top+10, 12, 22);
  ctx.fillStyle="#1f3fb7"; ctx.fillRect(left, top+torsoH, torsoW, 12); // shorts
  ctx.fillStyle="#f1c27d"; ctx.fillRect(x-9, top+torsoH+12, 8, 16); ctx.fillRect(x+1, top+torsoH+12, 8, 16);
}

function drawGuard(o){
  // chaqueta azul con texto gen√©rico
  ctx.fillStyle=o.jacket; ctx.fillRect(o.x,o.y,o.w,o.h);
  ctx.strokeStyle="#111"; ctx.lineWidth=2; ctx.strokeRect(o.x,o.y,o.w,o.h);
  ctx.fillStyle="#111"; ctx.font="bold 14px system-ui";
  const label="SEGURIDAD";
  const tw=ctx.measureText(label).width;
  ctx.fillText(label, o.x + (o.w-tw)/2, o.y+o.h/2+5);
  // cabeza
  ctx.beginPath(); ctx.arc(o.x+o.w/2, o.y-8, 8, 0, 2*Math.PI); ctx.fill();
}

function drawNopal(n){
  ctx.fillStyle="#16a34a"; ctx.beginPath(); ctx.arc(n.x,n.y,n.r,0,2*Math.PI); ctx.fill();
  ctx.strokeStyle="#0f5132"; ctx.stroke();
  ctx.fillStyle="#064e3b";
  for(let i=0;i<8;i++){ const a=i*Math.PI/4; ctx.beginPath(); ctx.arc(n.x+Math.cos(a)*(n.r-6), n.y+Math.sin(a)*(n.r-6), 2.5, 0, 2*Math.PI); ctx.fill(); }
}

function drawDrop(d){
  ctx.fillStyle=d.color; ctx.beginPath(); ctx.arc(d.x,d.y,d.r,0,2*Math.PI); ctx.fill();
  ctx.strokeStyle="#111"; ctx.lineWidth=2; ctx.stroke();
  ctx.fillStyle="#111"; ctx.font="bold 12px system-ui"; ctx.fillText(d.type==="agua"?"üíß":"üë¢", d.x-7, d.y+5);
}

/* ==================== l√≥gica ==================== */
function resetAll(){
  state.level=1; state.score=0; state.lives=3; state.hits=0;
  state.slowUntil=0; state.bootsUntil=0;
  player.reset(); makeLevel(state.level); updateHud();
}

function update(dt){
  // mover guardias
  for(const o of state.obstacles){
    o.x += o.v*60*dt;
    if(o.v>0 && o.x>W+10) o.x=-o.w-10;
    if(o.v<0 && o.x<-o.w-10) o.x=W+10;
  }

  // nopal frena
  let onNopal=false;
  for(const n of state.nopales){
    const dx=player.x-n.x, dy=player.y-n.y;
    if(Math.hypot(dx,dy)<n.r+18){ onNopal=true; break; }
  }
  if(onNopal && Date.now()>state.bootsUntil){ state.slowUntil=Date.now()+900; }

  // colisi√≥n con guardia
  for(const o of state.obstacles){
    if(rectHit(player.x-18,player.y-22,36,44, o.x,o.y,o.w,o.h)){ hit(); break; }
  }

  // drops
  for(let i=state.drops.length-1;i>=0;i--){
    const d=state.drops[i];
    if(circleHit(player.x,player.y,20, d.x,d.y,d.r)){
      if(d.type==="agua"){ state.lives++; toast("Vida extra üíß"); beep(1); }
      else { state.bootsUntil=Date.now()+6000; toast("Botas anti-nopal üë¢"); beep(2); }
      state.drops.splice(i,1); updateHud();
    }
  }

  // meta
  if(player.y<60){
    state.score += 100*state.level;
    state.level++;
    toast("Ya chinge ü•≥");
    beep(0);
    nextLevel();
  }
}

function nextLevel(){ saveSnapshot(); player.reset(); makeLevel(state.level); updateHud(); }
function hit(){
  state.hits++; state.lives--;
  toast("Se chingo üí•"); beep(0);
  if(state.lives<=0){ saveSnapshot(); state.running=false; stopMariachi(); updateHud(); return; }
  player.reset(); updateHud();
}

function rectHit(ax,ay,aw,ah,bx,by,bw,bh){ return ax<bx+bw && ax+aw>bx && ay<by+bh && ay+ah>by; }
function circleHit(ax,ay,ar,bx,by,br){ return Math.hypot(ax-bx,ay-by) < ar+br; }

/* ==================== input ==================== */
const keys=new Set();
window.addEventListener("keydown",e=>{
  if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)) e.preventDefault();
  keys.add(e.key);
  if(!ac){ audioInit(); startMariachi(); }
});
window.addEventListener("keyup",e=>keys.delete(e.key));
document.querySelectorAll(".kbd .btn").forEach(b=> b.addEventListener("click", ()=> moveDir(b.dataset.dir)));

function moveDir(dir){
  const base = (Date.now()<state.slowUntil) ? player.speed*0.35 : player.speed;
  const step = base*6;
  if(dir==="up") player.y-=step;
  if(dir==="down") player.y+=step;
  if(dir==="left") player.x-=step;
  if(dir==="right") player.x+=step;
  clampPlayer();
}
function handleKeys(dt){
  const base = (Date.now()<state.slowUntil) ? player.speed*0.35 : player.speed;
  const s = base*60*dt;
  if(keys.has("ArrowUp")) player.y-=s;
  if(keys.has("ArrowDown")) player.y+=s;
  if(keys.has("ArrowLeft")) player.x-=s;
  if(keys.has("ArrowRight")) player.x+=s;
  clampPlayer();
}
function clampPlayer(){ player.x=clamp(player.x,22,W-22); player.y=clamp(player.y,50,H-24); }

/* ==================== HUD / historial ==================== */
function updateHud(){
  $("#lives").textContent=state.lives;
  $("#score").textContent=state.score;
  $("#level").textContent=state.level;
  $("#hits").textContent=state.hits;
}
function toast(msg){
  const t=$("#toast"); t.style.display="flex";
  t.querySelector("span").textContent=msg;
  clearTimeout(toast._id);
  toast._id=setTimeout(()=> t.style.display="none", 1200);
}
function saveSnapshot(){
  const secs=((Date.now()-state.timeStart)/1000).toFixed(1);
  const row={date:new Date().toLocaleString(), level:state.level, score:state.score, lives:state.lives, hits:state.hits, time:secs};
  const key="cruzando_hist"; const arr=JSON.parse(localStorage.getItem(key)||"[]"); arr.unshift(row);
  localStorage.setItem(key, JSON.stringify(arr)); renderTable(arr);
}
function renderTable(arr){
  const tb=$("#table tbody"); tb.innerHTML="";
  for(const r of arr){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.date}</td><td>${r.level}</td><td>${r.score}</td><td>${r.lives}</td><td>${r.hits}</td><td>${r.time}s</td>`;
    tb.appendChild(tr);
  }
}
function loadTable(){ renderTable(JSON.parse(localStorage.getItem("cruzando_hist")||"[]")); }
$("#btnExport").addEventListener("click", ()=>{
  const arr=JSON.parse(localStorage.getItem("cruzando_hist")||"[]");
  const csv=["Fecha,Nivel,Puntos,Vidas,Golpes,Tiempo(s)"].concat(arr.map(r=>[r.date,r.level,r.score,r.lives,r.hits,r.time].join(","))).join("\n");
  const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"})); a.download="historial_cruzando.csv"; a.click();
});
$("#btnPrint").addEventListener("click", ()=>window.print());
$("#btnClear").addEventListener("click", ()=>{ if(confirm("¬øBorrar historial guardado?")){ localStorage.removeItem("cruzando_hist"); loadTable(); }});

/* ==================== bucle ==================== */
let prev=0;
function loop(ts){
  if(!state.running || state.paused){ prev=ts; requestAnimationFrame(loop); return; }
  const dt=(ts-prev)/1000; prev=ts;
  handleKeys(dt); update(dt);

  // escena
  drawTricolor();
  for(let y=80;y<H;y+=60){ ctx.save(); ctx.globalAlpha=.2; ctx.fillStyle="#fff"; ctx.fillRect(0,y,W,60); ctx.restore(); }

  state.nopales.forEach(drawNopal);
  state.obstacles.forEach(drawGuard);
  state.drops.forEach(drawDrop);
  drawPlayer();

  $("#time").textContent = `${((Date.now()-state.timeStart)/1000).toFixed(1)}s`;
  requestAnimationFrame(loop);
}

/* ==================== botones main ==================== */
$("#btnStart").addEventListener("click", ()=>{
  if(!state.running){
    resetAll(); state.running=true; state.paused=false; state.timeStart=Date.now();
    audioInit(); startMariachi();
  }
});
$("#btnPause").addEventListener("click", ()=>{
  if(!state.running) return;
  state.paused=!state.paused; toast(state.paused? "Pausado":"Reanudado");
  if(state.paused) stopMariachi(); else startMariachi();
});
$("#btnReset").addEventListener("click", ()=>{
  resetAll(); state.timeStart=Date.now(); state.running=true; state.paused=false;
  audioInit(); startMariachi();
});

/* init */
resetAll(); loadTable(); requestAnimationFrame(loop);
</script>
</body>
</html>
