<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Cruzando los Nopales ‚Äî ICE Co. Guards</title>
<style>
:root{ --rojo:#e11d48; --verde:#16a34a; --blanco:#ffffff; --negro:#111827; --azul:#1f3fb7; --amarillo:#f59e0b; }
html,body{height:100%;margin:0;background:#fff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--negro)}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
header{display:flex;flex-wrap:wrap;align-items:center;gap:10px;justify-content:space-between}
h1{margin:0;font-size:clamp(20px,3.5vw,34px);color:var(--rojo);text-shadow:0 2px 0 #fff}
.btn{cursor:pointer;border:2px solid var(--negro);border-radius:12px;padding:.45rem .8rem;font-weight:800;background:#fff;box-shadow:2px 3px 0 var(--negro)}
.grid{display:grid;grid-template-columns:1fr 320px;gap:12px}
canvas{width:100%;aspect-ratio:4/3;border:4px solid var(--negro);border-radius:16px;box-shadow:6px 8px 0 var(--negro);background:#fff}
.col{display:flex;flex-direction:column;gap:10px}
.status{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.tag{border:2px solid var(--negro);background:#fff;padding:.25rem .5rem;border-radius:10px;font-weight:700}
.hist{background:#fff;border:2px solid var(--negro);border-radius:14px;padding:10px;max-height:340px;overflow:auto}
table{border-collapse:collapse;width:100%} th,td{border:1px solid #ddd;padding:6px 8px;font-size:12px;text-align:center}
th{background:#f3f4f6;position:sticky;top:0}
.toast{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
.toast span{font-weight:900;font-size:clamp(22px,4.5vw,40px);background:rgba(255,255,255,.92);border:4px solid var(--negro);
padding:.6rem 1rem;border-radius:16px;box-shadow:6px 8px 0 var(--negro)}
.overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;text-align:center;padding:16px;background:rgba(255,255,255,.9)}
.overlay > div{background:#fff;border:3px dashed var(--rojo);border-radius:14px;padding:12px;max-width:560px}
details summary{cursor:pointer}

/* stop accidental zoom/pan on mobile while playing */
html, body { touch-action: none; overscroll-behavior: none; }
button, .btn { touch-action: manipulation; }
canvas { touch-action: none; }

/* Mobile layout */
@media (max-width: 900px){
  .grid{display:flex;flex-direction:column;gap:10px}
  canvas{
    width:100%;
    height:82svh;
    max-height:calc(100svh - 160px);
    aspect-ratio:auto;
  }
  .btn{font-size:14px;padding:6px 10px;border-radius:10px;box-shadow:3px 4px 0 var(--negro)}
  .status{gap:6px}
  .tag{font-size:14px}
  .hist{max-height:280px}
}
</style>
</head>
<body>
<div class="wrap">
<header>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button class="btn" id="btnStart">Iniciar</button>
    <button class="btn" id="btnPause">Pausar</button>
    <button class="btn" id="btnReset">Reiniciar</button>
    <button class="btn" id="btnAudio">M√∫sica: Encender/Apagar</button>
  </div>
</header>
<h1>üá≤üáΩ Cruzando los Nopales</h1>

<div class="grid">
  <div style="position:relative">
    <canvas id="game" width="800" height="600" aria-label="Juego Cruzando los Nopales"></canvas>
    <div class="toast" id="toast" style="display:none"><span></span></div>
    <div class="overlay" id="imgOverlay"><div>
      <b>Falta <code>player.png</code></b><br>
      Coloca tu caricatura en la misma carpeta que <code>index.html</code> con el nombre exacto <code>player.png</code>.
    </div></div>
    <div class="status">
      <span class="tag">Vidas: <b id="lives">3</b></span>
      <span class="tag">Puntos: <b id="score">0</b></span>
      <span class="tag">Nivel: <b id="level">1</b></span>
      <span class="tag">Golpes: <b id="hits">0</b></span>
      <span class="tag">Tiempo: <b id="time">0.0s</b></span>
    </div>
  </div>

  <div class="col">
    <div class="hist">
      <b>Historial</b>
      <div style="display:flex;gap:6px;margin:.4rem 0">
        <button class="btn" id="btnExport">Exportar CSV</button>
        <button class="btn" id="btnPrint">Imprimir reporte</button>
        <button class="btn" id="btnClear">Borrar historial</button>
      </div>
      <table id="table">
        <thead><tr><th>Fecha</th><th>Nivel</th><th>Puntos</th><th>Vidas</th><th>Golpes</th><th>Tiempo</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <details>
      <summary><b>GitHub Pages</b></summary>
      <ol>
        <li>Guarda este archivo como <code>index.html</code>.</li>
        <li>Pon en la misma carpeta: <code>player.png</code>, <code>ice1.png</code> ‚Ä¶ <code>ice5.png</code>, <code>yeha.mp3</code>, <code>cielito_lindo.mp3</code>, <code>frijoles.mp3</code>.</li>
        <li>Sube al repo ‚Üí Settings ‚Üí Pages ‚Üí Source: ‚Äúmain / root‚Äù.</li>
        <li>Abre la URL de Pages y presiona <b>Iniciar</b>.</li>
      </ol>
    </details>
  </div>
</div>
</div>

<!-- audio -->
<audio id="sYeha" src="yeha.mp3" preload="auto"></audio>
<audio id="sBg" src="cielito_lindo.mp3" preload="auto" loop></audio>
<audio id="sLose" src="frijoles.mp3" preload="auto"></audio>

<script>
/* ===== util ===== */
const $ = s=>document.querySelector(s);
const rand=(a,b)=>Math.random()*(b-a)+a;
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

/* prevent iOS zoom glitches */
['gesturestart','gesturechange','gestureend'].forEach(evt =>
  document.addEventListener(evt, e => e.preventDefault(), { passive:false })
);
let __lastTouch = 0;
document.addEventListener('touchend', e => {
  const now = Date.now();
  if (now - __lastTouch < 300) { e.preventDefault(); }
  __lastTouch = now;
}, { passive:false });

/* ===== canvas & state ===== */
const canvas=$("#game"), ctx=canvas.getContext("2d");
const W=canvas.width, H=canvas.height;

/* global scale: +23% sizes */
const SCALE = 1.23;

const state={
  running:false, paused:false,
  level:1, score:0, lives:3, hits:0,
  timeStart:0,
  slowUntil:0, bootsUntil:0,
  obstacles:[], nopales:[], drops:[],
  invincibleUntil: 0
};

/* base player size 28 ‚Üí scaled by 1.23 */
const BASE_PLAYER = 28;
const player={ x:W/2, y:H-60, size:Math.round(BASE_PLAYER*SCALE), speed:6, img:null, ready:false,
  reset(){ this.x=W/2; this.y=H-60; }
};

/* dynamic hitbox helpers relative to size */
function playerHitbox(){
  const s = player.size/BASE_PLAYER;
  const hw = 18*s, hhOff = 22*s, w = 36*s, h = 44*s;
  return { x: player.x - hw, y: player.y - hhOff, w, h };
}
function playerRadius(){ return 20 * (player.size/BASE_PLAYER); }
function playerNopalPad(){ return 18 * (player.size/BASE_PLAYER); }
function clampPlayer(){
  const padX = 22 * (player.size/BASE_PLAYER);
  const padBottom = 24 * (player.size/BASE_PLAYER);
  player.x=clamp(player.x,padX,W-padX);
  player.y=clamp(player.y,50,H-padBottom);
}

/* ===== sprites: player + ICE enemies ===== */
(function loadPlayer(){
  const img=new Image();
  img.onload=()=>{ player.img=img; player.ready=true; $("#imgOverlay").style.display="none"; };
  img.onerror=()=>{ player.ready=false; $("#imgOverlay").style.display="flex"; };
  img.src="player.png";
})();
const ENEMIES = { imgs:[], ready:false };
(function loadEnemies(){
  const names = ["ice1.png","ice2.png","ice3.png","ice4.png","ice5.png"];
  let loaded = 0;
  names.forEach((name,i)=>{
    const img = new Image();
    img.onload = ()=>{ ENEMIES.imgs[i]=img; loaded++; ENEMIES.ready = loaded>0; };
    img.onerror= ()=>{ ENEMIES.imgs[i]=null; ENEMIES.ready = ENEMIES.imgs.some(Boolean); };
    img.src = name;
  });
})();

/* ===== audio ===== */
const A = {
  yeha: $("#sYeha"),
  bg: $("#sBg"),
  lose: $("#sLose"),
  muted: false
};
function playYehaThenBg(){
  stopAll();
  A.yeha.currentTime = 0;
  A.yeha.play().then(()=> { A.yeha.onended = ()=> playBg(); })
                .catch(()=> { playBg(); });
}
function playBg(){ A.bg.currentTime = 0; A.bg.play().catch(()=>{}); }
function playLose_thenResume(){
  try{ A.bg.pause(); }catch{}
  A.lose.currentTime = 0;
  A.lose.play().then(()=>{ A.lose.onended = ()=>{ if(state.running && state.lives>0) playBg(); }; })
                .catch(()=>{ if(state.running && state.lives>0) playBg(); });
}
function stopAll(){ [A.yeha,A.bg,A.lose].forEach(a=>{ try{ a.pause(); a.currentTime=0; }catch{} }); }
function toggleMute(){ A.muted = !A.muted; [A.yeha,A.bg,A.lose].forEach(a=> a.muted = A.muted); }

/* ===== world/levels =====
   Easier curve: ~+8% speed/level (softer), caps reduced.
   Characters bigger: obstacle sizes & pickups scale with SCALE.
*/
function makeLevel(n){
  state.obstacles.length=0; state.nopales.length=0; state.drops.length=0;

  const lanes   = Math.min(6, 4 + Math.floor((n-1)/2));   // 4..6
  const perLane = Math.min(5, 3 + Math.floor((n-1)/2));   // 3..5
  const speedFactor = Math.min(2.2, Math.pow(1.08, n-1)); // gentler growth

  for(let i=0;i<lanes;i++){
    const y   = 120 + i*60;
    const dir = (i%2? 1 : -1);
    const minV = 0.9 * speedFactor;
    const maxV = 1.25 * speedFactor;

    const segment = W / perLane;
    for(let k=0;k<perLane;k++){
      const jitter = segment*0.35*(Math.random()-0.5);
      const x = k*segment + segment/2 + jitter;

      // choose ICE sprite
      let spriteIndex = -1;
      if (ENEMIES.ready){
        const candidates = ENEMIES.imgs.map((im,idx)=>im?idx:-1).filter(v=>v>=0);
        spriteIndex = candidates[Math.floor(Math.random()*candidates.length)];
      }

      state.obstacles.push({
        x, y,
        v: dir * rand(minV, maxV),
        w: Math.round(56*SCALE), h: Math.round(54*SCALE), // 23% bigger
        tie: (i%2? "#e11d48" : "#2563eb"),
        spriteIndex
      });
    }
  }

  const patches=4+Math.min(8,n*2);
  for(let i=0;i<patches;i++){
    state.nopales.push({ x:rand(30,W-80), y:rand(220,H-160), r:rand(22,36)*SCALE }); // bigger nopales
  }

  /* Drops (+23% radius) with weighted huaraches */
  const poolWeighted = [
    {type:"torta",     color:"#f97316"},
    {type:"pulque",    color:"#60a5fa"},
    {type:"huaraches", color:"#f59e0b"},
    {type:"huaraches", color:"#f59e0b"}
  ];
  const dropR = Math.round(14*SCALE); // base 14 ‚Üí ~17
  const count = 2 + Math.floor(Math.random()*2); // 2‚Äì3
  let hasHuaraches = false;
  for(let i=0;i<count;i++){
    const d = poolWeighted[Math.floor(Math.random()*poolWeighted.length)];
    if(d.type==="huaraches") hasHuaraches = true;
    state.drops.push({
      type:d.type,
      x:rand(30,W-30),
      y:rand(140,H-200),
      r:dropR,
      color:d.color
    });
  }
  if(!hasHuaraches){
    state.drops.push({type:"huaraches", x:rand(30,W-30), y:rand(140,H-200), r:dropR, color:"#f59e0b"});
  }
}

/* ===== drawing ===== */
function drawTricolor(){
  const stripe=H/3;
  ctx.fillStyle="#128a3a"; ctx.fillRect(0,0,W,stripe);
  ctx.fillStyle="#ffffff"; ctx.fillRect(0,stripe,W,stripe);
  ctx.fillStyle="#d01c1f"; ctx.fillRect(0,2*stripe,W,stripe);
  ctx.save(); ctx.globalAlpha=.18; ctx.fillStyle="#000"; ctx.fillRect(0,0,W,60); ctx.restore();
  ctx.strokeStyle="#111"; ctx.strokeRect(0,0,W,60);
  ctx.fillStyle="#111"; ctx.font="bold 16px system-ui";
  const label = "La Frontera";
  const tw = ctx.measureText(label).width;
  ctx.fillText(label, (W - tw)/2, 36);
}
function drawPlayer(){
  if(!player.ready || !player.img) return;
  const {x,y,size}=player;
  ctx.fillStyle="rgba(0,0,0,.15)";
  ctx.beginPath(); ctx.ellipse(x, y+size*0.9, size*0.8, size*0.35, 0, 0, Math.PI*2); ctx.fill();
  const h=size*2.8, w=h*0.9;
  ctx.drawImage(player.img, x-w/2, y-h/1.7, w, h);
}
function drawGuard(o){
  const x=o.x, y=o.y, w=o.w, h=o.h;
  const idx = o.spriteIndex;
  if (ENEMIES.ready && idx>=0 && ENEMIES.imgs[idx]){
    ctx.drawImage(ENEMIES.imgs[idx], x, y-h*0.15, w, h*1.15);
    return;
  }
  // fallback vector
  ctx.fillStyle="#111"; ctx.fillRect(x, y, w, h);
  ctx.fillStyle="#333"; ctx.fillRect(x+4, y+8, w-8, 10);
  ctx.fillStyle="#fff"; ctx.fillRect(x+10, y+18, w-20, 14);
  ctx.fillStyle=o.tie; ctx.fillRect(x+w/2-3, y+18, 6, 26);
  ctx.fillStyle="#d6a77a"; ctx.beginPath(); ctx.arc(x+w/2, y-10, 9, 0, 2*Math.PI); ctx.fill();
  ctx.fillStyle="#222"; ctx.fillRect(x+w/2-14, y-18, 28, 6); ctx.fillRect(x+w/2-10, y-26, 20, 10);
  ctx.fillStyle="#000"; ctx.fillRect(x+w/2-14, y-12, 12, 6); ctx.fillRect(x+w/2+2, y-12, 12, 6);
  ctx.fillRect(x+w/2-2, y-10, 4, 2);
  ctx.fillStyle="#444"; ctx.fillRect(x+w-10, y+h-18, 8, 14); ctx.fillRect(x+w-6, y+h-24, 2, 6);
  ctx.strokeStyle="#666"; ctx.lineWidth=1;
  ctx.beginPath();
  for(let i=0;i<6;i++){
    const px = x + w/2 + 10 + Math.cos(i*0.9)*3;
    const py = y - 8 + i*2;
    if(i===0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
  }
  ctx.stroke();
  ctx.fillStyle="#ffd54a"; ctx.fillRect(x+6, y+h-16, 28, 10);
  ctx.fillStyle="#111"; ctx.font="bold 8px system-ui"; ctx.fillText("ICE Co.", x+7, y+h-8);
}
function drawNopal(n){
  ctx.fillStyle="#16a34a"; ctx.beginPath(); ctx.arc(n.x,n.y,n.r,0,2*Math.PI); ctx.fill();
  ctx.strokeStyle="#0f5132"; ctx.stroke();
  ctx.fillStyle="#064e3b";
  for(let i=0;i<8;i++){ const a=i*Math.PI/4; ctx.beginPath(); ctx.arc(n.x+Math.cos(a)*(n.r-6), n.y+Math.sin(a)*(n.r-6), 2.5, 0, 2*Math.PI); ctx.fill(); }
}
function drawDrop(d){
  const icon = d.type==="torta" ? "ü•™" :
               d.type==="huaraches" ? "üë°" :
               d.type==="pulque" ? "üç∂" : "‚≠ê";
  ctx.fillStyle=d.color; ctx.beginPath(); ctx.arc(d.x,d.y,d.r,0,2*Math.PI); ctx.fill();
  ctx.strokeStyle="#111"; ctx.lineWidth=2; ctx.stroke();
  ctx.fillStyle="#111"; ctx.font="bold 14px system-ui"; ctx.fillText(icon, d.x-9, d.y+6);
}

/* ===== logic ===== */
function resetAll(){
  state.level=1; state.score=0; state.lives=3; state.hits=0;
  state.slowUntil=0; state.bootsUntil=0;
  player.reset();
  state.invincibleUntil = Date.now() + 1000;
  makeLevel(state.level); updateHud();
}
function update(dt){
  for(const o of state.obstacles){
    o.x += o.v*60*dt;
    if(o.v>0 && o.x>W+10) o.x=-o.w-10;
    if(o.v<0 && o.x<-o.w-10) o.x=W+10;
  }

  let onNopal=false;
  for(const n of state.nopales){
    const dx=player.x-n.x, dy=player.y-n.y;
    if(Math.hypot(dx,dy)<n.r + playerNopalPad()){ onNopal=true; break; }
  }
  if(onNopal && Date.now()>state.bootsUntil){ state.slowUntil=Date.now()+900; }

  if (Date.now() > state.invincibleUntil) {
    for(const o of state.obstacles){
      const hb = playerHitbox();
      if(rectHit(hb.x,hb.y,hb.w,hb.h, o.x,o.y,o.w,o.h)){ hit(); break; }
    }
  }

  for(let i=state.drops.length-1;i>=0;i--){
    const d=state.drops[i];
    if(circleHit(player.x,player.y,playerRadius(), d.x,d.y,d.r)){
      if(d.type==="torta"){ 
        state.lives++; toast("Torta ü•™ +1 vida");
      } else if(d.type==="huaraches"){
        state.bootsUntil=Date.now()+6000; toast("Huaraches üë° ¬°anti-nopal!");
      } else if(d.type==="pulque"){
        state.invincibleUntil = Math.max(state.invincibleUntil, Date.now()+1500);
        toast("Pulque üç∂ ¬°invencible!");
      }
      state.drops.splice(i,1); updateHud();
    }
  }

  if(player.y<60){
    state.score += 100*state.level;
    state.level++;
    toast("Ya chinge ü•≥");
    nextLevel();
  }
}
function nextLevel(){
  saveSnapshot();
  player.reset();
  state.invincibleUntil = Date.now() + 1000;
  makeLevel(state.level);
  updateHud();
}
function hit(){
  state.hits++; state.lives--;
  toast("Se chingo üí•");
  playLose_thenResume();
  if(state.lives<=0){ saveSnapshot(); state.running=false; updateHud(); return; }
  player.reset();
  state.invincibleUntil = Date.now() + 900;
  updateHud();
}

function rectHit(ax,ay,aw,ah,bx,by,bw,bh){ return ax<bx+bw && ax+aw>bx && ay<by+bh && ay+ah>by; }
function circleHit(ax,ay,ar,bx,by,br){ return Math.hypot(ax-bx,ay-by) < ar+br; }

/* ===== input ===== */
const keys=new Set();
window.addEventListener("keydown",e=>{
  if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)) e.preventDefault();
  keys.add(e.key);
});
window.addEventListener("keyup",e=>keys.delete(e.key));

function handleKeys(dt){
  const base = (Date.now()<state.slowUntil) ? player.speed*0.35 : player.speed;
  const s = base*60*dt;
  if(keys.has("ArrowUp")) player.y-=s;
  if(keys.has("ArrowDown")) player.y+=s;
  if(keys.has("ArrowLeft")) player.x-=s;
  if(keys.has("ArrowRight")) player.x+=s;
  clampPlayer();
}

/* touch drag */
let dragging = false;
function canvasToGameCoords(clientX, clientY){
  const r = canvas.getBoundingClientRect();
  const nx = (clientX - r.left) / r.width;
  const ny = (clientY - r.top) / r.height;
  return { x: nx * canvas.width, y: ny * canvas.height };
}
function movePlayerToClientPoint(clientX, clientY){
  const p = canvasToGameCoords(clientX, clientY);
  player.x = p.x; player.y = p.y; clampPlayer();
}
function onPointerDown(e){ dragging = true; movePlayerToClientPoint(e.clientX, e.clientY); e.preventDefault(); }
function onPointerMove(e){ if(!dragging) return; movePlayerToClientPoint(e.clientX, e.clientY); e.preventDefault(); }
function onPointerUp(e){ dragging = false; e.preventDefault(); }
canvas.addEventListener("pointerdown", onPointerDown, {passive:false});
window.addEventListener("pointermove", onPointerMove,   {passive:false});
window.addEventListener("pointerup",   onPointerUp,     {passive:false});
window.addEventListener("pointercancel", onPointerUp,   {passive:false});

/* ===== HUD / history ===== */
function updateHud(){
  $("#lives").textContent=state.lives;
  $("#score").textContent=state.score;
  $("#level").textContent=state.level;
  $("#hits").textContent=state.hits;
  $("#time").textContent=`${((Date.now()-state.timeStart)/1000).toFixed(1)}s`;
}
function toast(msg){
  const t=$("#toast"); t.style.display="flex";
  t.querySelector("span").textContent=msg;
  clearTimeout(toast._id);
  toast._id=setTimeout(()=> t.style.display="none", 1200);
}
function saveSnapshot(){
  const secs=((Date.now()-state.timeStart)/1000).toFixed(1);
  const row={date:new Date().toLocaleString(), level:state.level, score:state.score, lives:state.lives, hits:state.hits, time:secs};
  const key="cruzando_hist"; const arr=JSON.parse(localStorage.getItem(key)||"[]"); arr.unshift(row);
  localStorage.setItem(key, JSON.stringify(arr)); renderTable(arr);
}
function renderTable(arr){
  const tb=$("#table tbody"); tb.innerHTML="";
  for(const r of arr){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.date}</td><td>${r.level}</td><td>${r.score}</td><td>${r.lives}</td><td>${r.hits}</td><td>${r.time}s</td>`;
    tb.appendChild(tr);
  }
}
function loadTable(){ renderTable(JSON.parse(localStorage.getItem("cruzando_hist")||"[]")); }

/* ===== loop ===== */
let prev=0;
function loop(ts){
  if(!state.running || state.paused){ prev=ts; requestAnimationFrame(loop); return; }
  const dt=(ts-prev)/1000; prev=ts;

  handleKeys(dt); update(dt);

  drawTricolor();
  for(let y=80;y<H;y+=60){ ctx.save(); ctx.globalAlpha=.15; ctx.fillStyle="#fff"; ctx.fillRect(0,y,W,60); ctx.restore(); }

  state.nopales.forEach(drawNopal);
  state.obstacles.forEach(drawGuard);
  state.drops.forEach(drawDrop);
  drawPlayer();

  updateHud();
  requestAnimationFrame(loop);
}

/* ===== buttons ===== */
$("#btnStart").addEventListener("click", ()=>{
  if(!state.running){
    if(!player.ready){ $("#imgOverlay").style.display="flex"; return; }
    resetAll(); state.running=true; state.paused=false; state.timeStart=Date.now();
    playYehaThenBg();
  }
});
$("#btnPause").addEventListener("click", ()=>{
  if(!state.running) return;
  state.paused=!state.paused; toast(state.paused? "Pausado":"Reanudado");
  if(state.paused){ try{ A.bg.pause(); }catch{}; } else { playBg(); }
});
$("#btnReset").addEventListener("click", ()=>{
  resetAll(); state.timeStart=Date.now(); state.running=true; state.paused=false;
  playBg();
});
$("#btnAudio").addEventListener("click", toggleMute);
$("#btnExport").addEventListener("click", ()=>{
  const arr=JSON.parse(localStorage.getItem("cruzando_hist")||"[]");
  const csv=["Fecha,Nivel,Puntos,Vidas,Golpes,Tiempo(s)"].concat(arr.map(r=>[r.date,r.level,r.score,r.lives,r.hits,r.time].join(","))).join("\n");
  const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"})); a.download="historial_cruzando.csv"; a.click();
});
$("#btnPrint").addEventListener("click", ()=>window.print());
$("#btnClear").addEventListener("click", ()=>{ if(confirm("¬øBorrar historial guardado?")){ localStorage.removeItem("cruzando_hist"); loadTable(); }});

/* init */
resetAll(); loadTable(); requestAnimationFrame(loop);
</script>
</body>
</html>
