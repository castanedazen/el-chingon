<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Cruzando los Nopales ‚Äî ICE Co. Guards</title>
<style>
:root{ --rojo:#e11d48; --negro:#111827; }
html,body{height:100%;margin:0;background:#fff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--negro)}
/* keep a bit of bottom inset so Safari toolbar never covers the canvas */
body{ padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 8px); }
.wrap{max-width:900px;margin:0 auto;padding:10px}
header{display:flex;flex-wrap:wrap;align-items:center;gap:8px}
h1{margin:6px 0 10px;font-size:clamp(18px,4.8vw,28px);color:var(--rojo)}
.btn{cursor:pointer;border:2px solid var(--negro);border-radius:12px;padding:.42rem .7rem;font-weight:800;background:#fff;box-shadow:2px 3px 0 var(--negro)}
input[type=range]{width:150px}
.stage{position:relative}
canvas{width:100%;aspect-ratio:8/9;border:4px solid var(--negro);border-radius:16px;box-shadow:6px 8px 0 var(--negro);background:#fff;display:block}

/* HUD floats over canvas to save space */
.hud{position:absolute;left:8px;top:8px;display:flex;gap:6px;flex-wrap:wrap;pointer-events:none}
.tag{background:#fff;border:2px solid var(--negro);padding:.18rem .45rem;border-radius:10px;font-weight:800;font-size:13px}

/* toast & overlays */
.toast{position:absolute;inset:0;display:none;align-items:center;justify-content:center;pointer-events:none}
.toast span{font-weight:900;font-size:clamp(20px,5vw,40px);background:rgba(255,255,255,.92);border:4px solid var(--negro);padding:.55rem .9rem;border-radius:16px;box-shadow:6px 8px 0 var(--negro)}
.overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;text-align:center;padding:16px;background:rgba(255,255,255,.9)}
.overlay > div{background:#fff;border:3px dashed var(--rojo);border-radius:14px;padding:12px;max-width:560px}

/* Stop accidental zoom/pan while playing */
html, body { touch-action: none; overscroll-behavior: none; }
button, .btn { touch-action: manipulation; }
canvas { touch-action: none; }

/* PHONE: JS sets exact height to ~92‚Äì95% of visible viewport */
@media (max-width: 900px){
  .wrap{padding:8px}
  header{gap:6px}
  .btn{font-size:14px;padding:.35rem .6rem;border-radius:10px;box-shadow:3px 4px 0 var(--negro)}
}

/* hide old history/side bits entirely (we're maximizing the play area) */
.grid, .col, .hist, details{ display:none !important; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <button class="btn" id="btnPause">Pausar</button>
    <button class="btn" id="btnReset">Reiniciar</button>
    <button class="btn" id="btnAudio">M√∫sica</button>
    <label style="font-weight:700">Volumen <input id="vol" type="range" min="0" max="1" step="0.01" value="0.6"></label>
  </header>
  <h1>üá≤üáΩ Cruzando los Nopales</h1>

  <div class="stage">
    <canvas id="game" width="800" height="900" aria-label="Juego Cruzando los Nopales"></canvas>

    <div class="hud">
      <span class="tag">Vidas: <b id="lives">3</b></span>
      <span class="tag">Puntos: <b id="score">0</b></span>
      <span class="tag">Nivel: <b id="level">1</b></span>
      <span class="tag">Golpes: <b id="hits">0</b></span>
      <span class="tag">Tiempo: <b id="time">0.0s</b></span>
      <span class="tag" id="shieldTag" style="display:none">üõ°Ô∏è</span>
      <span class="tag" id="slowTag" style="display:none">üé∫</span>
    </div>

    <div class="toast" id="toast"><span></span></div>
    <div class="overlay" id="imgOverlay"><div>
      <b>Falta <code>player.png</code></b><br>
      Coloca tu caricatura junto a <code>index.html</code> con nombre exacto <code>player.png</code>.
    </div></div>
  </div>
</div>

<!-- audio -->
<audio id="sYeha" src="yeha.mp3" preload="auto"></audio>
<audio id="sBg"   src="cielito_lindo.mp3" preload="auto" loop></audio>
<audio id="sLose" src="frijoles.mp3" preload="auto"></audio>

<script>
/* ===== util ===== */
const $ = s=>document.querySelector(s);
const rand=(a,b)=>Math.random()*(b-a)+a;
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const lerp=(a,b,t)=>a+(b-a)*t;

/* ===== Hi-DPI canvas ===== */
const canvas=$("#game"), ctx=canvas.getContext("2d");
const DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1));
const LOGICAL_W=800, LOGICAL_H=900; // tall field = better phone fill
canvas.width = LOGICAL_W * DPR; canvas.height = LOGICAL_H * DPR;
canvas.style.width = LOGICAL_W+"px"; canvas.style.height = LOGICAL_H+"px";
ctx.scale(DPR,DPR);
const W=LOGICAL_W, H=LOGICAL_H;

/* Fit canvas to ~92‚Äì95% of visible viewport, avoiding toolbars */
function vpH(){ return (window.visualViewport?.height) || window.innerHeight; }
function fitCanvas(){
  const stage = canvas.parentElement;
  const cw = stage.clientWidth;
  const headerH = document.querySelector('header')?.getBoundingClientRect().height || 0;
  const titleH  = document.querySelector('h1')?.getBoundingClientRect().height || 0;
  const safeB = parseFloat(getComputedStyle(document.body).getPropertyValue('padding-bottom'))||0;
  const pad = 12;
  const availH = Math.max(300, vpH() - headerH - titleH - safeB - pad); // ~90‚Äì95%
  let targetW = cw, targetH = targetW * (H/W);
  if (targetH > availH) { targetH = availH; targetW = targetH * (W/H); }
  canvas.style.width = Math.round(targetW) + 'px';
  canvas.style.height = Math.round(targetH) + 'px';
}
window.addEventListener('resize', fitCanvas);
window.addEventListener('orientationchange', fitCanvas);
window.visualViewport && window.visualViewport.addEventListener('resize', fitCanvas);

/* prevent iOS zoom glitches on quick double taps */
['gesturestart','gesturechange','gestureend'].forEach(evt =>
  document.addEventListener(evt, e => e.preventDefault(), { passive:false })
);

/* ===== sizes ===== */
const SCALE_PLAYER = 1.5; // +50%
const SCALE_GUARD  = 1.5; //